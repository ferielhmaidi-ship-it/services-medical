{% extends 'base_admin.html.twig' %}

{% block title %}Gestion des Médecins{% endblock %}

{% block body %}
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Gestion des Médecins</h1>
        <div>
            <span class="badge badge-primary">
                <i class="fas fa-user-md"></i> {{ medecins|length }} Médecin(s)
            </span>
        </div>
    </div>

    <!-- Filter Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-filter"></i> Filtres de recherche
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Statut Filter -->
                <div class="col-md-4 mb-3">
                    <label for="filterStatus"><strong>Statut du compte</strong></label>
                    <select id="filterStatus" class="form-control select2">
                        <option value="">Tous les statuts</option>
                        <option value="Actif">Actif</option>
                        <option value="Inactif">Inactif</option>
                    </select>
                </div>

                <!-- Vérification Filter -->
                <div class="col-md-4 mb-3">
                    <label for="filterVerified"><strong>Vérification</strong></label>
                    <select id="filterVerified" class="form-control select2">
                        <option value="">Tous les états</option>
                        <option value="Vérifié">Vérifié</option>
                        <option value="Non vérifié">Non vérifié</option>
                    </select>
                </div>

                <!-- Spécialité Filter -->
                <div class="col-md-4 mb-3">
                    <label for="filterSpecialty"><strong>Spécialité médicale</strong></label>
                    <select id="filterSpecialty" class="form-control select2">
                        <option value="">Toutes les spécialités</option>
                        {% for specialty in specialties|sort %}
                            <option value="{{ specialty }}">{{ specialty }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12">
                    <button id="resetFilters" class="btn btn-secondary btn-sm">
                        <i class="fas fa-redo"></i> Réinitialiser les filtres
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- DataTales Example -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Liste des Médecins</h6>
            <div class="dropdown">
                <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button"
                        id="exportDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-download"></i> Exporter
                </button>
                <div class="dropdown-menu" aria-labelledby="exportDropdown">
                    <a class="dropdown-item" href="#" onclick="exportTable('csv')">
                        <i class="fas fa-file-csv text-success"></i> CSV
                    </a>
                    <a class="dropdown-item" href="#" onclick="exportTable('excel')">
                        <i class="fas fa-file-excel text-success"></i> Excel
                    </a>
                    <a class="dropdown-item" href="#" onclick="exportTable('pdf')">
                        <i class="fas fa-file-pdf text-danger"></i> PDF
                    </a>
                    <a class="dropdown-item" href="#" onclick="window.print()">
                        <i class="fas fa-print text-primary"></i> Imprimer
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                    <thead class="thead-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nom Complet</th>
                            <th>Email</th>
                            <th data-filter="specialty">Spécialité</th>
                            <th>CIN</th>
                            <th>Téléphone</th>
                            <th data-filter="status">Statut</th>
                            <th data-filter="verified">Vérifié</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for medecin in medecins %}
                        <tr>
                            <td>{{ medecin.id }}</td>
                            <td>
                                <strong>{{ medecin.getFullName() }}</strong><br>
                                <small class="text-muted">{{ medecin.age ? medecin.age ~ ' ans' : 'Âge non spécifié' }}</small>
                            </td>
                            <td>
                                {{ medecin.email }}
                            </td>
                            <td data-sort="{{ medecin.specialty }}" data-filter="{{ medecin.specialty }}">
                                <span class="badge badge-info">{{ medecin.specialty }}</span>
                            </td>
                            <td>{{ medecin.cin }}</td>
                            <td>
                                {% if medecin.phoneNumber %}
                                    <a href="tel:{{ medecin.phoneNumber }}" class="text-primary">
                                        <i class="fas fa-phone"></i> {{ medecin.phoneNumber }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">Non renseigné</span>
                                {% endif %}
                            </td>
                            <td data-sort="{{ medecin.isActive ? '1' : '0' }}" data-filter="{{ medecin.isActive ? 'Actif' : 'Inactif' }}">
                                {% if medecin.isActive %}
                                    <span class="badge badge-success"><i class="fas fa-check"></i> Actif</span>
                                {% else %}
                                    <span class="badge badge-danger"><i class="fas fa-times"></i> Inactif</span>
                                {% endif %}
                            </td>
                            <td data-sort="{{ medecin.isVerified ? '1' : '0' }}" data-filter="{{ medecin.isVerified ? 'Vérifié' : 'Non vérifié' }}">
                                {% if medecin.isVerified %}
                                    <span class="badge badge-success"><i class="fas fa-check-circle"></i> Vérifié</span>
                                {% else %}
                                    <span class="badge badge-warning"><i class="fas fa-clock"></i> En attente</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ path('admin_medecin_show', {'id': medecin.id}) }}"
                                       class="btn btn-info btn-sm"
                                       data-toggle="tooltip"
                                       title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ path('admin_medecin_edit', {'id': medecin.id}) }}"
                                       class="btn btn-warning btn-sm"
                                       data-toggle="tooltip"
                                       title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-danger btn-sm"
                                            data-toggle="modal"
                                            data-target="#deleteModal{{ medecin.id }}"
                                            title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>

                                <!-- Delete Modal -->
                                <div class="modal fade" id="deleteModal{{ medecin.id }}" tabindex="-1" role="dialog">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Confirmer la suppression</h5>
                                                <button type="button" class="close" data-dismiss="modal">
                                                    <span>&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <p>Êtes-vous sûr de vouloir supprimer le médecin <strong>{{ medecin.getFullName() }}</strong> ?</p>
                                                <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Cette action est irréversible !</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                                                <form method="post" action="{{ path('admin_medecin_delete', {'id': medecin.id}) }}" style="display: inline;">
                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ medecin.id) }}">
                                                    <button type="submit" class="btn btn-danger">
                                                        <i class="fas fa-trash"></i> Supprimer
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <i class="fas fa-user-md fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Aucun médecin trouvé</h5>
                                <p class="text-muted">Les médecins inscrits apparaîtront ici</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <!-- DataTables Buttons Extension -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <script>
        $(document).ready(function() {
            // Extract unique specialties for filter
            let specialties = new Set();
            $('#dataTable tbody tr').each(function() {
                const specialty = $(this).find('td[data-filter]').eq(0).data('filter');
                if (specialty) {
                    specialties.add(specialty);
                }
            });

            // Populate specialty filter if empty
            if ($('#filterSpecialty option').length <= 1) {
                $('#filterSpecialty').empty();
                $('#filterSpecialty').append('<option value="">Toutes les spécialités</option>');
                Array.from(specialties).sort().forEach(function(specialty) {
                    $('#filterSpecialty').append('<option value="' + specialty + '">' + specialty + '</option>');
                });
            }

            // Initialize DataTable
            var table = $('#dataTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json",
                    "search": "Recherche générale:",
                    "searchPlaceholder": "Nom, email, téléphone..."
                },
                "order": [[0, "desc"]],
                "pageLength": 10,
                "responsive": true,
                "dom": 'Bfrtip',
                "buttons": [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: 'btn btn-success btn-sm',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7]
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        className: 'btn btn-danger btn-sm',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7]
                        },
                        orientation: 'landscape',
                        pageSize: 'A4'
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print"></i> Imprimer',
                        className: 'btn btn-info btn-sm',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7]
                        },
                        customize: function (win) {
                            $(win.document.body)
                                .css('font-size', '10pt')
                                .prepend('<h3>Liste des Médecins - MediNest</h3>');

                            $(win.document.body).find('table')
                                .addClass('compact')
                                .css('font-size', 'inherit');
                        }
                    }
                ],
                "columnDefs": [
                    {
                        "targets": [8], // Actions column
                        "orderable": false,
                        "searchable": false
                    }
                ],
                "initComplete": function() {
                    // Initialize Select2 on filter dropdowns
                    $('.select2').select2({
                        theme: 'bootstrap4',
                        placeholder: "Sélectionner",
                        allowClear: true
                    });

                    // Add custom search input for each column
                    this.api().columns().every(function() {
                        var column = this;
                        var header = $(column.header());

                        // Only add search to columns with data-filter attribute
                        if (header.attr('data-filter')) {
                            var columnIndex = column.index();
                            var filterId = 'column-search-' + columnIndex;

                            // Add search input
                            $('<input type="text" class="form-control form-control-sm mt-1" placeholder="Filtrer...">')
                                .appendTo(header)
                                .on('keyup change clear', function() {
                                    if (column.search() !== this.value) {
                                        column.search(this.value).draw();
                                    }
                                });
                        }
                    });
                }
            });

            // Status Filter
            $('#filterStatus').on('change', function() {
                var status = $(this).val();
                var column = table.column(6); // Status column index

                if (status === '') {
                    column.search('').draw();
                } else {
                    column.search('^' + status + '$', true, false).draw();
                }
            });

            // Verified Filter
            $('#filterVerified').on('change', function() {
                var verified = $(this).val();
                var column = table.column(7); // Verified column index

                if (verified === '') {
                    column.search('').draw();
                } else {
                    column.search('^' + verified + '$', true, false).draw();
                }
            });

            // Specialty Filter
            $('#filterSpecialty').on('change', function() {
                var specialty = $(this).val();
                var column = table.column(3); // Specialty column index

                if (specialty === '') {
                    column.search('').draw();
                } else {
                    column.search('^' + specialty + '$', true, false).draw();
                }
            });

            // Reset Filters
            $('#resetFilters').on('click', function() {
                $('#filterStatus').val('').trigger('change');
                $('#filterVerified').val('').trigger('change');
                $('#filterSpecialty').val('').trigger('change');

                // Clear all column searches
                table.columns().search('').draw();

                // Reset Select2
                $('.select2').val(null).trigger('change');
            });

            // Export functions
            window.exportTable = function(type) {
                if (type === 'csv') {
                    table.button('.buttons-excel').trigger();
                } else if (type === 'excel') {
                    table.button('.buttons-excel').trigger();
                } else if (type === 'pdf') {
                    table.button('.buttons-pdf').trigger();
                }
            };

            // Show active filters count
            function updateFilterCount() {
                var activeFilters = 0;

                if ($('#filterStatus').val()) activeFilters++;
                if ($('#filterVerified').val()) activeFilters++;
                if ($('#filterSpecialty').val()) activeFilters++;

                // Check column searches
                table.columns().every(function() {
                    if (this.search()) {
                        activeFilters++;
                    }
                });

                if (activeFilters > 0) {
                    $('#resetFilters').html('<i class="fas fa-redo"></i> Réinitialiser (' + activeFilters + ' filtre(s) actif(s))');
                } else {
                    $('#resetFilters').html('<i class="fas fa-redo"></i> Réinitialiser les filtres');
                }
            }

            // Update filter count on change
            $('#filterStatus, #filterVerified, #filterSpecialty').on('change', updateFilterCount);
            table.on('draw', updateFilterCount);

            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>

    <style>
        /* Custom styles for filters */
        .dataTables_wrapper .dataTables_filter {
            float: none;
            text-align: left;
            margin-bottom: 10px;
        }

        .dataTables_wrapper .dataTables_filter input {
            margin-left: 0;
            width: 100%;
        }

        .filter-badge {
            cursor: pointer;
        }

        .filter-badge:hover {
            opacity: 0.8;
        }

        /* Column search inputs */
        table.dataTable thead th {
            position: relative;
        }

        table.dataTable thead th input {
            width: 100%;
            box-sizing: border-box;
            padding: 3px;
            font-size: 12px;
        }

        /* Make buttons responsive */
        .dt-buttons {
            margin-bottom: 10px;
        }

        .dt-buttons .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
    </style>
{% endblock %}
