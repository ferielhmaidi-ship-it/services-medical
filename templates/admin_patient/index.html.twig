{# templates/admin_patient/index.html.twig #}
{% extends 'base_admin.html.twig' %}

{% block title %}Gestion des Patients{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {% include 'magazine-admin/magazine/_styles.html.twig' %}
{% endblock %}

{% block body %}
    <section class="mag-shell">
        <div class="container-fluid">
            <!-- Page Heading -->
            <div class="mag-header">
                <div>
                    <h1 class="mag-title">Gestion des Patients</h1>
                    <p class="mag-subtitle">Consultez et gérez les comptes des patients inscrits.</p>
                </div>
                <div class="mag-toolbar">
                    <a href="{{ path('admin_patient_new') }}" class="btn btn-primary btn-sm rounded-pill px-3 me-2">
                        <i class="fas fa-plus me-1"></i> Ajouter un Patient
                    </a>
                    <span class="badge rounded-pill bg-light text-primary border px-3 py-2">
                        <i class="fas fa-user-injured me-1"></i> {{ patients|length }} Patient(s)
                    </span>
                </div>
            </div>

            <!-- main Listing -->
            <div class="mag-card pb-0">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Liste des Patients</h6>
                </div>
                <div class="table-responsive">
                    <table class="table mag-table table-hover mb-0" id="patientTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th class="border-0 ps-3">ID</th>
                                <th class="border-0">Nom Complet</th>
                                <th class="border-0">Email</th>
                                <th class="border-0">Téléphone</th>
                                <th class="border-0">Date de Naissance</th>
                                <th class="border-0">Assurance</th>
                                <th class="border-0">Statut</th>
                                <th class="border-0 text-end pe-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for patient in patients %}
                            <tr>
                                <td class="ps-3 align-middle text-muted">#{{ patient.id }}</td>
                                <td class="align-middle">
                                    <span class="fw-bold" style="color: var(--mag-ink);">{{ patient.getFullName() }}</span><br>
                                    <small class="text-muted">{{ patient.age ? patient.age ~ ' ans' : 'Âge non spécifié' }}</small>
                                </td>
                                <td class="align-middle text-muted small">
                                    {{ patient.email }}
                                </td>
                                <td class="align-middle">
                                    {% if patient.phoneNumber %}
                                        <a href="tel:{{ patient.phoneNumber }}" class="text-primary text-decoration-none small">
                                            <i class="fas fa-phone me-1"></i> {{ patient.phoneNumber }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted small">Non renseigné</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle text-muted small">
                                    {% if patient.dateOfBirth %}
                                        {{ patient.dateOfBirth|date('d/m/Y') }}<br>
                                        <small>({{ calculate_age(patient.dateOfBirth) }} ans)</small>
                                    {% else %}
                                        <span class="text-muted">Non spécifiée</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle">
                                    {% if patient.hasInsurance %}
                                        <span class="badge rounded-pill px-3" style="background-color: #e8f0fe; color: #1967d2;"><i class="fas fa-check me-1"></i> Oui</span><br>
                                        <small class="text-muted" style="font-size: 10px;">{{ patient.insuranceNumber ?? 'N° non renseigné' }}</small>
                                    {% else %}
                                        <span class="badge rounded-pill px-3" style="background-color: #fff4e5; color: #b06000;"><i class="fas fa-times me-1"></i> Non</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle">
                                    {% if patient.isActive %}
                                        <span class="badge rounded-pill px-3" style="background-color: #e6f4ea; color: #1e7e34;">Actif</span>
                                    {% else %}
                                        <span class="badge rounded-pill px-3" style="background-color: #fce8e6; color: #d93025;">Inactif</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle text-end pe-3">
                                    <div class="mag-actions justify-content-end">
                                        <a href="{{ path('admin_patient_show', {'id': patient.id}) }}"
                                           class="btn btn-outline-primary btn-sm rounded-pill"
                                           data-toggle="tooltip"
                                           title="Voir détails">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ path('admin_patient_edit', {'id': patient.id}) }}"
                                           class="btn btn-outline-warning btn-sm rounded-pill"
                                           data-toggle="tooltip"
                                           title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-outline-danger btn-sm rounded-pill"
                                                data-toggle="modal"
                                                data-target="#deleteModal{{ patient.id }}"
                                                title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>

                                    <!-- Delete Modal -->
                                    <div class="modal fade" id="deleteModal{{ patient.id }}" tabindex="-1" role="dialog">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content border-0 shadow-lg" style="border-radius: 18px;">
                                                <div class="modal-header border-bottom-0">
                                                    <h5 class="modal-title fw-bold">Confirmer la suppression</h5>
                                                    <button type="button" class="close" data-dismiss="modal">
                                                        <span>&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body text-center py-4">
                                                    <div class="mb-3">
                                                        <i class="fas fa-exclamation-circle text-danger fa-4x"></i>
                                                    </div>
                                                    <p class="mb-1">Êtes-vous sûr de vouloir supprimer le patient</p>
                                                    <h5 class="fw-bold mb-3">{{ patient.getFullName() }} ?</h5>
                                                    <p class="text-muted small mb-0">Cette action est irréversible et supprimera toutes les données associées.</p>
                                                </div>
                                                <div class="modal-footer border-top-0 justify-content-center pb-4">
                                                    <button type="button" class="btn btn-light rounded-pill px-4" data-dismiss="modal">Annuler</button>
                                                    <form method="post" action="{{ path('admin_patient_delete', {'id': patient.id}) }}" style="display: inline;">
                                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ patient.id) }}">
                                                        <button type="submit" class="btn btn-danger rounded-pill px-4">
                                                            <i class="fas fa-trash me-1"></i> Supprimer définitivement
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <i class="fas fa-user-injured fa-3x text-muted mb-3 opacity-50"></i>
                                    <h5 class="text-muted">Aucun patient trouvé</h5>
                                    <p class="text-muted small">Les nouveaux inscrits apparaîtront ici automatiquement.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function() {
            // Initialize DataTable
            $('#patientTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json",
                    "search": "Recherche:",
                    "searchPlaceholder": "Filtrer..."
                },
                "order": [[0, "desc"]],
                "pageLength": 10,
                "responsive": true
            });

            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
{% endblock %}
