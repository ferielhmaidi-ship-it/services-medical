{# templates/assistant.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Assistant IA MÃ©dical{% endblock %}

{% block body %}
<div style="max-width:1000px; margin:140px auto; padding:30px; background:#f8f9fa; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">

    <h1 style="text-align:center; color:#007BFF; margin-bottom:30px;">
        ğŸ¤– Assistant IA MÃ©dical
    </h1>

    {# Messages flash #}
    {% for message in app.flashes('error') %}
        <div style="background:#f8d7da; color:#721c24; padding:12px; border-radius:6px; margin-bottom:15px; border:1px solid #f5c6cb;">
            âš ï¸ {{ message }}
        </div>
    {% endfor %}

    {# Formulaire #}
    <form method="post" enctype="multipart/form-data" style="margin-bottom:30px;">
        
        {# Upload PDF optionnel #}
        <div style="background:#fff; padding:15px; border-radius:8px; border:2px dashed #6c757d; margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold; color:#333; cursor:pointer;">
                ğŸ“ Optionnel : Importer un fichier PDF mÃ©dical
                <span style="font-weight:normal; color:#6c757d; font-size:14px;">(laissez vide pour utiliser la base de donnÃ©es)</span>
            </label>
            <input 
                type="file" 
                name="pdf_file" 
                id="pdf_file" 
                accept=".pdf,application/pdf"
                style="width:100%; padding:8px;"
            >
        </div>

        {# Question #}
        <div style="margin-bottom:15px;">
            <label for="prompt" style="display:block; margin-bottom:8px; font-weight:bold; color:#333;">
                â“ Votre question :
            </label>
            <textarea
                name="prompt"
                id="prompt"
                rows="4"
                style="width:100%; padding:12px; font-size:16px; border:2px solid #dee2e6; border-radius:8px; resize:vertical;"
                placeholder="Poser une question"
                required
            >{{ prompt|default('') }}</textarea>
        </div>

        <button type="submit" style="width:100%; padding:12px 30px; background:#007BFF; color:white; border:none; border-radius:6px; font-size:16px; cursor:pointer;">
            ğŸ” Envoyer la question
        </button>
    </form>

    {# Indicateur du mode utilisÃ© #}
    {% if answer is defined and answer %}
        <div style="background:#d1ecf1; color:#0c5460; padding:10px 15px; border-radius:6px; margin-bottom:15px; font-size:14px;">
            {% if mode == 'pdf' %}
                ğŸ“„ Mode : Analyse PDF
            {% elseif mode == 'google' %}
                ğŸŒ Mode : Recherche Google (info non trouvÃ©e en base)
            {% else %}
                ğŸ—„ï¸ Mode : Base de donnÃ©es
            {% endif %}
        </div>
    {% endif %}

    {# Affichage du contenu PDF extrait #}
    {% if pdf_content is defined and pdf_content and mode == 'pdf' %}
        <div style="background:#fff; border:1px solid #dee2e6; border-radius:8px; overflow:hidden; margin-bottom:20px;">
            <div style="background:#6c757d; color:white; padding:12px; font-weight:bold; cursor:pointer;" onclick="togglePdfContent()">
                ğŸ“„ Contenu du PDF extrait (cliquer pour afficher/masquer)
            </div>
            <div id="pdfContent" style="padding:15px; max-height:200px; overflow-y:auto; background:#f8f9fa; font-family:monospace; font-size:12px; display:none;">
                <pre style="margin:0; white-space:pre-wrap;">{{ pdf_content }}</pre>
            </div>
        </div>
    {% endif %}

    {# Affichage des rÃ©sultats Google (si mode google) #}
    {% if mode == 'google' and search_results is defined and search_results %}
        <div style="background:#fff; border:1px solid #dee2e6; border-radius:8px; overflow:hidden; margin-bottom:20px;">
            <div style="background:#ea4335; color:white; padding:12px; font-weight:bold; cursor:pointer;" onclick="toggleGoogleResults()">
                ğŸ” RÃ©sultats de recherche Google (cliquer pour afficher/masquer)
            </div>
            <div id="googleResults" style="padding:15px; max-height:200px; overflow-y:auto; background:#f8f9fa; font-family:monospace; font-size:12px; display:none;">
                <pre style="margin:0; white-space:pre-wrap;">{{ search_results }}</pre>
            </div>
        </div>
    {% endif %}

    {# RÃ©ponse de l'IA #}
    {% if answer is defined and answer %}
        <div style="background:#fff; border:1px solid #dee2e6; border-radius:8px; overflow:hidden;">
            <div style="background:#198754; color:white; padding:15px; font-weight:bold;">
                ğŸ“‹ RÃ©ponse de l'IA
            </div>
            <div style="padding:20px; line-height:1.6;">
                {{ answer|nl2br }}
            </div>
        </div>
        
        <div style="margin-top:20px; text-align:center; color:#6c757d; font-size:14px;">
            RÃ©ponse gÃ©nÃ©rÃ©e par Llama3 via Ollama
        </div>
    {% endif %}

</div>

<script>
function togglePdfContent() {
    var content = document.getElementById('pdfContent');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
}

function toggleGoogleResults() {
    var content = document.getElementById('googleResults');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
}
</script>
{% endblock %}
